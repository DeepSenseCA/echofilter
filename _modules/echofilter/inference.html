
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>echofilter.inference &#8212; Echofilter 1.0.dev0 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Echofilter 1.0.dev0 documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contents:
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/usage_guide.html">
   Usage Guide
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../source/programs/programs.html">
   CLI Reference
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../source/programs/inference.html">
     echofilter
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../source/programs/ev2csv.html">
     ev2csv
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../source/programs/train.html">
     echofilter-train
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../source/programs/generate_shards.html">
     echofilter-generate-shards
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../source/packages/modules.html">
   API Reference
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../source/packages/echofilter.html">
     echofilter package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../source/packages/echofilter.data.html">
       echofilter.data package
      </a>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../source/packages/echofilter.nn.html">
       echofilter.nn package
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
      <label for="toctree-checkbox-4">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../source/packages/echofilter.nn.modules.html">
         echofilter.nn.modules package
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../source/packages/echofilter.optim.html">
       echofilter.optim package
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../source/packages/echofilter.raw.html">
       echofilter.raw package
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../source/packages/echofilter.ui.html">
       echofilter.ui package
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../source/packages/echofilter.win.html">
       echofilter.win package
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/changelog.html">
   Changelog
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../py-modindex.html">
   Module Index
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../genindex.html">
   Index
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <h1>Source code for echofilter.inference</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Inference routine.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># This file is part of Echofilter.</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2020-2022  Scott C. Lowe and Offshore Energy Research Association (OERA)</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as</span>
<span class="c1"># published by the Free Software Foundation, version 3.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span> <span class="k">as</span> <span class="n">mcolors</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">echofilter.data.transforms</span>
<span class="kn">import</span> <span class="nn">echofilter.nn</span>
<span class="kn">from</span> <span class="nn">echofilter.nn.unet</span> <span class="kn">import</span> <span class="n">UNet</span>
<span class="kn">from</span> <span class="nn">echofilter.nn.utils</span> <span class="kn">import</span> <span class="n">count_parameters</span>
<span class="kn">from</span> <span class="nn">echofilter.nn.wrapper</span> <span class="kn">import</span> <span class="n">Echofilter</span>
<span class="kn">import</span> <span class="nn">echofilter.path</span>
<span class="kn">import</span> <span class="nn">echofilter.raw</span>
<span class="kn">from</span> <span class="nn">echofilter.raw.manipulate</span> <span class="kn">import</span> <span class="n">join_transect</span><span class="p">,</span> <span class="n">split_transect</span>
<span class="kn">from</span> <span class="nn">echofilter.raw.utils</span> <span class="kn">import</span> <span class="n">fillholes2d</span>
<span class="kn">import</span> <span class="nn">echofilter.ui</span>
<span class="kn">import</span> <span class="nn">echofilter.ui.checkpoints</span>
<span class="kn">import</span> <span class="nn">echofilter.utils</span>
<span class="kn">import</span> <span class="nn">echofilter.win</span>

<span class="kn">from</span> <span class="nn">echofilter.ui.inference_cli</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DEFAULT_VARNAME</span><span class="p">,</span>
    <span class="n">cli</span><span class="p">,</span>
    <span class="n">main</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">EV_UNDEFINED_DEPTH</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10000.99</span>


<div class="viewcode-block" id="run_inference"><a class="viewcode-back" href="../../source/packages/echofilter.html#echofilter.inference.run_inference">[docs]</a><span class="k">def</span> <span class="nf">run_inference</span><span class="p">(</span>
    <span class="n">paths</span><span class="p">,</span>
    <span class="n">source_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">recursive_dir_search</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">extensions</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span>
    <span class="n">skip_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skip_incompatible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">continue_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">overwrite_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">overwrite_ev_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">import_into_evfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">generate_turbulence_line</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">generate_bottom_line</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">generate_surface_line</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">add_nearfield_line</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">suffix_file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">suffix_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">color_turbulence</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">,</span>
    <span class="n">color_turbulence_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">color_bottom</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">,</span>
    <span class="n">color_bottom_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">color_surface</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="n">color_surface_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">color_nearfield</span><span class="o">=</span><span class="s2">&quot;mediumseagreen&quot;</span><span class="p">,</span>
    <span class="n">thickness_turbulence</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">thickness_turbulence_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">thickness_bottom</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">thickness_bottom_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">thickness_surface</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">thickness_surface_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">thickness_nearfield</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cache_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">suffix_csv</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">keep_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">line_status</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">offset_turbulence</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">offset_bottom</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">offset_surface</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">nearfield</span><span class="o">=</span><span class="mf">1.7</span><span class="p">,</span>
    <span class="n">cutoff_at_nearfield</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lines_during_passive</span><span class="o">=</span><span class="s2">&quot;interpolate-time&quot;</span><span class="p">,</span>
    <span class="n">collate_passive_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">collate_removed_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">minimum_passive_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">minimum_removed_length</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">minimum_patch_area</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">patch_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">variable_name</span><span class="o">=</span><span class="n">DEFAULT_VARNAME</span><span class="p">,</span>
    <span class="n">row_len_selector</span><span class="o">=</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span>
    <span class="n">facing</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">use_training_standardization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">crop_min_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">crop_max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">autocrop_threshold</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
    <span class="n">image_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_unconditioned</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">logit_smoothing_sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hide_echoview</span><span class="o">=</span><span class="s2">&quot;new&quot;</span><span class="p">,</span>
    <span class="n">minimize_echoview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform inference on input files, and write output lines in EVL and regions</span>
<span class="sd">    in EVR file formats.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    paths : iterable</span>
<span class="sd">        Files and folders to be processed. These may be full paths or paths</span>
<span class="sd">        relative to `source_dir`. For each folder specified, any files with</span>
<span class="sd">        extension `&quot;csv&quot;` within the folder and all its tree of subdirectories</span>
<span class="sd">        will be processed.</span>
<span class="sd">    source_dir : str, optional</span>
<span class="sd">        Path to directory where files are found. Default is `&quot;.&quot;`.</span>
<span class="sd">    recursive_dir_search : bool, optional</span>
<span class="sd">        How to handle directory inputs in `paths`. If `False`, only files</span>
<span class="sd">        (with the correct extension) in the directory will be included.</span>
<span class="sd">        If `True`, subdirectories will also be walked through to find input</span>
<span class="sd">        files. Default is `True`.</span>
<span class="sd">    extensions : iterable or str, optional</span>
<span class="sd">        File extensions to detect when running on a directory. Default is</span>
<span class="sd">        `&quot;csv&quot;`.</span>
<span class="sd">    skip_existing : bool, optional</span>
<span class="sd">        Skip processing files which already have all outputs present. Default</span>
<span class="sd">        is `False`.</span>
<span class="sd">    skip_incompatible : bool, optional</span>
<span class="sd">        Skip processing CSV files which do not seem to contain an exported</span>
<span class="sd">        Echoview transect. If `False`, an error is raised. Default is `False`.</span>
<span class="sd">    output_dir : str, optional</span>
<span class="sd">        Directory where output files will be written. If this is an empty</span>
<span class="sd">        string (`&quot;&quot;`, default), outputs are written to the same directory as</span>
<span class="sd">        each input file. Otherwise, they are written to `output_dir`,</span>
<span class="sd">        preserving their path relative to `source_dir` if relative paths were</span>
<span class="sd">        used.</span>
<span class="sd">    dry_run : bool, optional</span>
<span class="sd">        If `True`, perform a trial run with no changes made. Default is</span>
<span class="sd">        `False`.</span>
<span class="sd">    continue_on_error : bool, default=False</span>
<span class="sd">        Continue running on remaining files if one file hits an error.</span>
<span class="sd">    overwrite_existing : bool, optional</span>
<span class="sd">        Overwrite existing outputs without producing a warning message. If</span>
<span class="sd">        `False`, an error is generated if files would be overwritten.</span>
<span class="sd">        Default is `False`.</span>
<span class="sd">    overwrite_ev_lines : bool, optional</span>
<span class="sd">        Overwrite existing lines within the Echoview file without warning.</span>
<span class="sd">        If `False` (default), the current datetime will be appended to line</span>
<span class="sd">        variable names in the event of a collision.</span>
<span class="sd">    import_into_evfile : bool, optional</span>
<span class="sd">        Whether to import the output lines and regions into the EV file,</span>
<span class="sd">        whenever the file being processed in an EV file. Default is `True`.</span>
<span class="sd">    generate_turbulence_line : bool, optional</span>
<span class="sd">        Whether to output an evl file for the turbulence line. If this is</span>
<span class="sd">        `False`, the turbulence line is also never imported into Echoview.</span>
<span class="sd">        Default is `True`.</span>
<span class="sd">    generate_bottom_line : bool, optional</span>
<span class="sd">        Whether to output an evl file for the bottom line. If this is `False`,</span>
<span class="sd">        the bottom line is also never imported into Echoview.</span>
<span class="sd">        Default is `True`.</span>
<span class="sd">    generate_surface_line : bool, optional</span>
<span class="sd">        Whether to output an evl file for the surface line. If this is `False`,</span>
<span class="sd">        the surface line is also never imported into Echoview.</span>
<span class="sd">        Default is `True`.</span>
<span class="sd">    add_nearfield_line : bool, optional</span>
<span class="sd">        Whether to add a nearfield line to the EV file in Echoview.</span>
<span class="sd">        Default is `True`.</span>
<span class="sd">    suffix_file : str, optional</span>
<span class="sd">        Suffix to append to output artifacts (evl and evr files), between</span>
<span class="sd">        the name of the file and the extension. If `suffix_file` begins with</span>
<span class="sd">        an alphanumeric character, `&quot;-&quot;` is prepended. Default is `&quot;&quot;`.</span>
<span class="sd">    suffix_var : str or None, optional</span>
<span class="sd">        Suffix to append to line and region names when imported back into</span>
<span class="sd">        EV file. If `suffix_var` begins with an alphanumeric character, `&quot;-&quot;`</span>
<span class="sd">        is prepended. If `None` (default), suffix_var will match `suffix_file`</span>
<span class="sd">        if it is set, and will be &quot;_echofilter&quot; otherwise.</span>
<span class="sd">    color_turbulence : str, optional</span>
<span class="sd">        Color to use for the turbulence line when it is imported into Echoview.</span>
<span class="sd">        This can either be the name of a supported color from</span>
<span class="sd">        matplotlib.colors, or a hexadecimal color, or a string representation</span>
<span class="sd">        of an RGB color to supply directly to Echoview (such as &quot;(0,255,0)&quot;).</span>
<span class="sd">        Default is `&quot;orangered&quot;`.</span>
<span class="sd">    color_turbulence_offset : str or None, optional</span>
<span class="sd">        Color to use for the offset turbulence line when it is imported into</span>
<span class="sd">        Echoview. If `None` (default) `color_turbulence` is used.</span>
<span class="sd">    color_bottom : str, optional</span>
<span class="sd">        Color to use for the bottom line when it is imported into Echoview.</span>
<span class="sd">        This can either be the name of a supported color from</span>
<span class="sd">        matplotlib.colors, or a hexadecimal color, or a string representation</span>
<span class="sd">        of an RGB color to supply directly to Echoview (such as &quot;(0,255,0)&quot;).</span>
<span class="sd">        Default is `&quot;orangered&quot;`.</span>
<span class="sd">    color_bottom_offset : str or None, optional</span>
<span class="sd">        Color to use for the offset bottom line when it is imported into</span>
<span class="sd">        Echoview. If `None` (default) `color_bottom` is used.</span>
<span class="sd">    color_surface : str, optional</span>
<span class="sd">        Color to use for the surface line when it is imported into Echoview.</span>
<span class="sd">        This can either be the name of a supported color from</span>
<span class="sd">        matplotlib.colors, or a hexadecimal color, or a string representation</span>
<span class="sd">        of an RGB color to supply directly to Echoview (such as &quot;(0,255,0)&quot;).</span>
<span class="sd">        Default is `&quot;green&quot;`.</span>
<span class="sd">    color_surface_offset : str or None, optional</span>
<span class="sd">        Color to use for the offset surface line when it is imported into</span>
<span class="sd">        Echoview. If `None` (default) `color_surface` is used.</span>
<span class="sd">    color_nearfield : str, optional</span>
<span class="sd">        Color to use for the nearfield line when it is created in Echoview.</span>
<span class="sd">        This can either be the name of a supported color from</span>
<span class="sd">        matplotlib.colors, or a hexadecimal color, or a string representation</span>
<span class="sd">        of an RGB color to supply directly to Echoview (such as &quot;(0,255,0)&quot;).</span>
<span class="sd">        Default is `&quot;mediumseagreen&quot;`.</span>
<span class="sd">    thickness_turbulence : int, optional</span>
<span class="sd">        Thickness with which the turbulence line will be displayed in Echoview.</span>
<span class="sd">        Default is `2`.</span>
<span class="sd">    thickness_turbulence_offset : str or None, optional</span>
<span class="sd">        Thickness with which the offset turbulence line will be displayed in</span>
<span class="sd">        Echoview. If `None` (default) `thickness_turbulence` is used.</span>
<span class="sd">    thickness_bottom : int, optional</span>
<span class="sd">        Thickness with which the bottom line will be displayed in Echoview.</span>
<span class="sd">        Default is `2`.</span>
<span class="sd">    thickness_bottom_offset : str or None, optional</span>
<span class="sd">        Thickness with which the offset bottom line will be displayed in</span>
<span class="sd">        Echoview. If `None` (default) `thickness_bottom` is used.</span>
<span class="sd">    thickness_surface : int, optional</span>
<span class="sd">        Thickness with which the surface line will be displayed in Echoview.</span>
<span class="sd">        Default is `1`.</span>
<span class="sd">    thickness_surface_offset : str or None, optional</span>
<span class="sd">        Thickness with which the offset surface line will be displayed in</span>
<span class="sd">        Echoview. If `None` (default) `thickness_surface` is used.</span>
<span class="sd">    thickness_nearfield : int, optional</span>
<span class="sd">        Thickness with which the nearfield line will be displayed in Echoview.</span>
<span class="sd">        Default is `1`.</span>
<span class="sd">    cache_dir : str or None, optional</span>
<span class="sd">        Path to directory where downloaded checkpoint files should be cached.</span>
<span class="sd">        If `None` (default), an OS-appropriate application-specific default</span>
<span class="sd">        cache directory is used.</span>
<span class="sd">    cache_csv : str or None, optional</span>
<span class="sd">        Path to directory where CSV files generated from EV inputs should be</span>
<span class="sd">        cached. If `None` (default), EV files which are exported to CSV files</span>
<span class="sd">        are temporary files, deleted after this program has completed. If</span>
<span class="sd">        `cache_csv=&quot;&quot;`, the CSV files are cached in the same directory as the</span>
<span class="sd">        input EV files.</span>
<span class="sd">    suffix_csv : str, optional</span>
<span class="sd">        Suffix used for cached CSV files which are exported from EV files.</span>
<span class="sd">        If `suffix_file` begins with an alphanumeric character, a delimiter</span>
<span class="sd">        is prepended. The delimiter is `&quot;.&quot;` if `keep_ext=True` or `&quot;-&quot;` if</span>
<span class="sd">        `keep_ext=False`. Default is `&quot;&quot;`.</span>
<span class="sd">    keep_ext : bool, optional</span>
<span class="sd">        Whether to preserve the file extension in the input file name when</span>
<span class="sd">        generating output file name. Default is `False`, removing the</span>
<span class="sd">        extension.</span>
<span class="sd">    line_status : int, optional</span>
<span class="sd">        Status to use for the lines.</span>
<span class="sd">        Must be one of:</span>

<span class="sd">        - `0` : none</span>
<span class="sd">        - `1` : unverified</span>
<span class="sd">        - `2` : bad</span>
<span class="sd">        - `3` : good</span>

<span class="sd">        Default is `3`.</span>
<span class="sd">    offset_turbulence : float, optional</span>
<span class="sd">        Offset for turbulence line, which moves the turbulence line deeper.</span>
<span class="sd">        Default is `1.0`.</span>
<span class="sd">    offset_bottom : float, optional</span>
<span class="sd">        Offset for bottom line, which moves the line to become more shallow.</span>
<span class="sd">        Default is `1.0`.</span>
<span class="sd">    offset_surface : float, optional</span>
<span class="sd">        Offset for surface line, which moves the surface line deeper.</span>
<span class="sd">        Default is `1.0`.</span>
<span class="sd">    nearfield : float, optional</span>
<span class="sd">        Nearfield approach distance, in metres.</span>
<span class="sd">        If the echogram is downward facing, the nearfield cutoff depth</span>
<span class="sd">        will be at a depth equal to the nearfield distance.</span>
<span class="sd">        If the echogram is upward facing, the nearfield cutoff will be</span>
<span class="sd">        `nearfield` meters above the deepest depth recorded in the input</span>
<span class="sd">        data.</span>
<span class="sd">        When processing an EV file, by default a nearfield line will be</span>
<span class="sd">        added at the nearfield cutoff depth. To prevent this behaviour,</span>
<span class="sd">        use the --no-nearfield-line argument.</span>
<span class="sd">        Default is `1.7`.</span>
<span class="sd">    cutoff_at_nearfield : bool or None, optional</span>
<span class="sd">        Whether to cut-off the turbulence line (for downfacing data) or bottom</span>
<span class="sd">        line (for upfacing) when it is closer to the echosounder than the</span>
<span class="sd">        `nearfield` distance.</span>
<span class="sd">        If `None` (default), the bottom line is clipped (for upfacing data),</span>
<span class="sd">        but the turbulence line is not clipped (even with downfacing data).</span>
<span class="sd">    lines_during_passive : str, optional</span>
<span class="sd">        Method used to handle line depths during collection</span>
<span class="sd">        periods determined to be passive recording instead of</span>
<span class="sd">        active recording.</span>
<span class="sd">        Options are:</span>

<span class="sd">        `&quot;interpolate-time&quot;`</span>
<span class="sd">            depths are linearly interpolated from active</span>
<span class="sd">            recording periods, using the time at which</span>
<span class="sd">            recordings where made.</span>
<span class="sd">        `&quot;interpolate-index&quot;`</span>
<span class="sd">            depths are linearly interpolated from active</span>
<span class="sd">            recording periods, using the index of the</span>
<span class="sd">            recording.</span>
<span class="sd">        `&quot;predict&quot;`</span>
<span class="sd">            the model&#39;s prediction for the lines during</span>
<span class="sd">            passive data collection will be kept; the nature</span>
<span class="sd">            of the prediction depends on how the model was</span>
<span class="sd">            trained.</span>
<span class="sd">        `&quot;redact&quot;`</span>
<span class="sd">            no depths are provided during periods determined</span>
<span class="sd">            to be passive data collection.</span>
<span class="sd">        `&quot;undefined&quot;`</span>
<span class="sd">            depths are replaced with the placeholder value</span>
<span class="sd">            used by Echoview to denote undefined values,</span>
<span class="sd">            which is `-10000.99`.</span>

<span class="sd">        Default: &quot;interpolate-time&quot;.</span>
<span class="sd">    collate_passive_length : int, optional</span>
<span class="sd">        Maximum interval, in ping indices, between detected passive regions</span>
<span class="sd">        which will removed to merge consecutive passive regions together</span>
<span class="sd">        into a single, collated, region. Default is 10.</span>
<span class="sd">    collate_passive_length : int, optional</span>
<span class="sd">        Maximum interval, in ping indices, between detected blocks</span>
<span class="sd">        (vertical rectangles) marked for removal which will also be removed</span>
<span class="sd">        to merge consecutive removed blocks together into a single,</span>
<span class="sd">        collated, region. Default is 10.</span>
<span class="sd">    minimum_passive_length : int, optional</span>
<span class="sd">        Minimum length, in ping indices, which a detected passive region</span>
<span class="sd">        must have to be included in the output. Set to -1 to omit all</span>
<span class="sd">        detected passive regions from the output. Default is 10.</span>
<span class="sd">    minimum_removed_length : int, optional</span>
<span class="sd">        Minimum length, in ping indices, which a detected removal block</span>
<span class="sd">        (vertical rectangle) must have to be included in the output.</span>
<span class="sd">        Set to -1 to omit all detected removal blocks from the output</span>
<span class="sd">        (default). Recommended minimum length is 10.</span>
<span class="sd">    minimum_patch_area : int, optional</span>
<span class="sd">        Minimum area, in pixels, which a detected removal patch</span>
<span class="sd">        (contour/polygon) region must have to be included in the output.</span>
<span class="sd">        Set to -1 to omit all detected patches from the output (default).</span>
<span class="sd">        Recommended minimum length 25.</span>
<span class="sd">    patch_mode : str or None, optional</span>
<span class="sd">        Type of mask patches to use. Must be supported by the</span>
<span class="sd">        model checkpoint used. Should be one of:</span>

<span class="sd">        `&quot;merged&quot;`</span>
<span class="sd">            Target patches for training were determined</span>
<span class="sd">            after merging as much as possible into the</span>
<span class="sd">            turbulence and bottom lines.</span>
<span class="sd">        `&quot;original&quot;`</span>
<span class="sd">            Target patches for training were determined</span>
<span class="sd">            using original lines, before expanding the</span>
<span class="sd">            turbulence and bottom lines.</span>
<span class="sd">        `&quot;ntob&quot;`</span>
<span class="sd">            Target patches for training were determined</span>
<span class="sd">            using the original bottom line and the merged</span>
<span class="sd">            turbulence line.</span>

<span class="sd">        If `None` (default), `&quot;merged&quot;` is used if downfacing and `&quot;ntob&quot;` is</span>
<span class="sd">        used if upfacing.</span>
<span class="sd">    variable_name : str, optional</span>
<span class="sd">        Name of the Echoview acoustic variable to load from EV files. Default</span>
<span class="sd">        is `&quot;Fileset1: Sv pings T1&quot;`.</span>
<span class="sd">    row_len_selector : str, optional</span>
<span class="sd">        Method used to handle input csv files with different number of Sv</span>
<span class="sd">        values across time (i.e. a non-rectangular input). Default is `&quot;mode&quot;`.</span>
<span class="sd">        See :meth:`echofilter.raw.loader.transect_loader` for options.</span>
<span class="sd">    facing : {&quot;downward&quot;, &quot;upward&quot;, &quot;auto&quot;}, optional</span>
<span class="sd">        Orientation in which the echosounder is facing. Default is `&quot;auto&quot;`,</span>
<span class="sd">        in which case the orientation is determined from the ordering of the</span>
<span class="sd">        depth values in the data (increasing = `&quot;upward&quot;`,</span>
<span class="sd">        decreasing = `&quot;downward&quot;`).</span>
<span class="sd">    use_training_standardization : bool, optional</span>
<span class="sd">        Whether to use the exact normalization center and deviation values as</span>
<span class="sd">        used during training. If `False` (default), the center and deviation</span>
<span class="sd">        are determined per sample, using the same method methodology as used</span>
<span class="sd">        to determine the center and deviation values for training.</span>
<span class="sd">    crop_min_depth : float or None, optional</span>
<span class="sd">        Minimum depth to include in input. If `None` (default), there is no</span>
<span class="sd">        minimum depth.</span>
<span class="sd">    crop_max_depth : float or None, optional</span>
<span class="sd">        Maxmimum depth to include in input. If `None` (default), there is no</span>
<span class="sd">        maximum depth.</span>
<span class="sd">    autocrop_threshold : float, optional</span>
<span class="sd">        Minimum fraction of input height which must be found to be removable</span>
<span class="sd">        for the model to be re-run with an automatically cropped input.</span>
<span class="sd">        Default is 0.35.</span>
<span class="sd">    image_height : int or None, optional</span>
<span class="sd">        Height in pixels of input to model. The data loaded from the csv will</span>
<span class="sd">        be resized to this height (the width of the image is unchanged).</span>
<span class="sd">        If `None` (default), the height matches that used when the model was</span>
<span class="sd">        trained.</span>
<span class="sd">    checkpoint : str or None, optional</span>
<span class="sd">        A path to a checkpoint file, or name of a checkpoint known to this</span>
<span class="sd">        package (listed in `echofilter/checkpoints.yaml`). If `None` (default),</span>
<span class="sd">        the first checkpoint in `checkpoints.yaml` is used.</span>
<span class="sd">    force_unconditioned : bool, optional</span>
<span class="sd">        Whether to always use unconditioned logit outputs. If `False`</span>
<span class="sd">        (default) conditional logits will be used if the checkpoint loaded is</span>
<span class="sd">        for a conditional model.</span>
<span class="sd">    logit_smoothing_sigma : float, optional</span>
<span class="sd">        Standard deviation over which logits will be smoothed before being</span>
<span class="sd">        converted into output. Default is `1`.</span>
<span class="sd">    device : str or torch.device or None, optional</span>
<span class="sd">        Name of device on which the model will be run. If `None`, the first</span>
<span class="sd">        available CUDA GPU is used if any are found, and otherwise the CPU is</span>
<span class="sd">        used. Set to `&quot;cpu&quot;` to use the CPU even if a CUDA GPU is available.</span>
<span class="sd">    hide_echoview : {&quot;never&quot;, &quot;new&quot;, &quot;always&quot;}, optional</span>
<span class="sd">        Whether to hide the Echoview window entirely while the code runs.</span>
<span class="sd">        If ``hide_echoview=&quot;new&quot;``, the application is only hidden if it</span>
<span class="sd">        was created by this function, and not if it was already running.</span>
<span class="sd">        If ``hide_echoview=&quot;always&quot;``, the application is hidden even if it was</span>
<span class="sd">        already running. In the latter case, the window will be revealed again</span>
<span class="sd">        when this function is completed. Default is `&quot;new&quot;`.</span>
<span class="sd">    minimize_echoview : bool, optional</span>
<span class="sd">        If `True`, the Echoview window being used will be minimized while this</span>
<span class="sd">        function is running. Default is `False`.</span>
<span class="sd">    verbose : int, optional</span>
<span class="sd">        Verbosity level. Default is `2`. Set to `0` to disable print</span>
<span class="sd">        statements, or elevate to a higher number to increase verbosity.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">t_start_prog</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">progress_fmt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">dryrun_fmt</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">progress_fmt</span>
    <span class="p">)</span>

    <span class="n">existing_file_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Run with overwrite_existing=True (with the command line&quot;</span>
        <span class="s2">&quot; interface, use the --force flag) to overwrite existing&quot;</span>
        <span class="s2">&quot; outputs.&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">progress_fmt</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Starting inference </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">HighlightStyle</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                    <span class="s2">&quot;dry-run&quot;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s2">&quot;routine&quot;</span><span class="p">,</span>
                    <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">HighlightStyle</span><span class="o">.</span><span class="n">reset</span><span class="p">,</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%A, %B </span><span class="si">%d</span><span class="s2">, %Y at %H:%M:%S&quot;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">facing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">facing</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
    <span class="k">if</span> <span class="n">facing</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;down&quot;</span><span class="p">):</span>
        <span class="n">facing</span> <span class="o">=</span> <span class="s2">&quot;downward&quot;</span>
    <span class="k">if</span> <span class="n">facing</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;up&quot;</span><span class="p">):</span>
        <span class="n">facing</span> <span class="o">=</span> <span class="s2">&quot;upward&quot;</span>

    <span class="k">if</span> <span class="n">suffix_file</span> <span class="ow">and</span> <span class="n">suffix_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
        <span class="n">suffix_file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">suffix_file</span>

    <span class="k">if</span> <span class="n">suffix_var</span> <span class="ow">and</span> <span class="n">suffix_var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
        <span class="n">suffix_var</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">suffix_var</span>
    <span class="k">elif</span> <span class="n">suffix_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">suffix_file</span><span class="p">:</span>
        <span class="n">suffix_var</span> <span class="o">=</span> <span class="n">suffix_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">suffix_var</span> <span class="o">=</span> <span class="s2">&quot;_echofilter&quot;</span>

    <span class="k">if</span> <span class="n">suffix_csv</span> <span class="ow">and</span> <span class="n">suffix_csv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">keep_ext</span><span class="p">:</span>
            <span class="n">suffix_csv</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">suffix_csv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix_csv</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">suffix_csv</span>

    <span class="n">line_colors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">turbulence</span><span class="o">=</span><span class="n">color_turbulence</span><span class="p">,</span>
        <span class="n">turbulence_offset</span><span class="o">=</span><span class="n">color_turbulence_offset</span><span class="p">,</span>
        <span class="n">bottom</span><span class="o">=</span><span class="n">color_bottom</span><span class="p">,</span>
        <span class="n">bottom_offset</span><span class="o">=</span><span class="n">color_bottom_offset</span><span class="p">,</span>
        <span class="n">surface</span><span class="o">=</span><span class="n">color_surface</span><span class="p">,</span>
        <span class="n">surface_offset</span><span class="o">=</span><span class="n">color_surface_offset</span><span class="p">,</span>
        <span class="n">nearfield</span><span class="o">=</span><span class="n">color_nearfield</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">line_thicknesses</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">turbulence</span><span class="o">=</span><span class="n">thickness_turbulence</span><span class="p">,</span>
        <span class="n">turbulence_offset</span><span class="o">=</span><span class="n">thickness_turbulence_offset</span><span class="p">,</span>
        <span class="n">bottom</span><span class="o">=</span><span class="n">thickness_bottom</span><span class="p">,</span>
        <span class="n">bottom_offset</span><span class="o">=</span><span class="n">thickness_bottom_offset</span><span class="p">,</span>
        <span class="n">surface</span><span class="o">=</span><span class="n">thickness_surface</span><span class="p">,</span>
        <span class="n">surface_offset</span><span class="o">=</span><span class="n">thickness_surface_offset</span><span class="p">,</span>
        <span class="n">nearfield</span><span class="o">=</span><span class="n">thickness_nearfield</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Carry over default line colours and thicknesses</span>
    <span class="k">for</span> <span class="n">lname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;turbulence&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;surface&quot;</span><span class="p">]:</span>
        <span class="n">key_source</span> <span class="o">=</span> <span class="n">lname</span>
        <span class="n">key_dest</span> <span class="o">=</span> <span class="n">lname</span> <span class="o">+</span> <span class="s2">&quot;_offset&quot;</span>
        <span class="k">if</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">key_dest</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">line_colors</span><span class="p">[</span><span class="n">key_dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">key_source</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">line_thicknesses</span><span class="p">[</span><span class="n">key_dest</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">line_thicknesses</span><span class="p">[</span><span class="n">key_dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_thicknesses</span><span class="p">[</span><span class="n">key_source</span><span class="p">]</span>

    <span class="c1"># Load checkpoint</span>
    <span class="n">checkpoint</span><span class="p">,</span> <span class="n">ckpt_name</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">checkpoints</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span>
        <span class="n">checkpoint</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">return_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">image_height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image_height</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample_shape&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">use_training_standardization</span><span class="p">:</span>
        <span class="n">center_param</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data_center&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">80.0</span><span class="p">)</span>
        <span class="n">deviation_param</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data_deviation&quot;</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">center_param</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;center_method&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">)</span>
        <span class="n">deviation_param</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deviation_method&quot;</span><span class="p">,</span> <span class="s2">&quot;stdev&quot;</span><span class="p">)</span>
    <span class="n">nan_value</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nan_value&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Constructing U-Net model, with arguments:&quot;</span><span class="p">)</span>
        <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_parameters&quot;</span><span class="p">])</span>
    <span class="n">unet</span> <span class="o">=</span> <span class="n">UNet</span><span class="p">(</span><span class="o">**</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_parameters&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">logit_smoothing_sigma</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
        <span class="n">max_logit_smoothing_sigma</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">logit_smoothing_sigma</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_logit_smoothing_sigma</span> <span class="o">=</span> <span class="n">logit_smoothing_sigma</span>
    <span class="k">if</span> <span class="n">max_logit_smoothing_sigma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">max_logit_smoothing_sigma</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)))</span>
        <span class="n">ks</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>  <span class="c1"># Increment to odd number if even</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">unet</span><span class="p">,</span>
            <span class="n">echofilter</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">GaussianSmoothing</span><span class="p">(</span>
                <span class="n">channels</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_parameters&quot;</span><span class="p">][</span><span class="s2">&quot;out_channels&quot;</span><span class="p">],</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="n">ks</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">logit_smoothing_sigma</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">unet</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Echofilter</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">mapping</span><span class="o">=</span><span class="n">checkpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wrapper_mapping&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="o">**</span><span class="n">checkpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wrapper_params&quot;</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="p">)</span>
    <span class="n">is_conditional_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;conditional&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Built </span><span class="si">{}</span><span class="s2">model with </span><span class="si">{}</span><span class="s2"> trainable parameters&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;conditional &quot;</span> <span class="k">if</span> <span class="n">is_conditional_model</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">count_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">only_trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">unet</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded U-Net state from the checkpoint&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Warning: Checkpoint doesn&#39;t seem to be for the UNet.&quot;</span>
                <span class="s2">&quot;Trying to load it as the whole model instead.&quot;</span>
            <span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded model state from the checkpoint&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Could not load the checkpoint state as either the whole model&quot;</span>
                <span class="s2">&quot;or the unet component.&quot;</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">err</span>

    <span class="c1"># Ensure model is on correct device</span>
    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># Put model in evaluation mode</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="n">files_input</span> <span class="o">=</span> <span class="n">paths</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">echofilter</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">parse_files_in_folders</span><span class="p">(</span>
            <span class="n">paths</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">,</span> <span class="n">extensions</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive_dir_search</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">progress_fmt</span><span class="p">(</span>
                <span class="s2">&quot;Processing </span><span class="si">{}{}</span><span class="s2"> file</span><span class="si">{}{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">HighlightStyle</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span>
                    <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span>
                    <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">HighlightStyle</span><span class="o">.</span><span class="n">reset</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;ev&quot;</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
        <span class="n">do_open</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">do_open</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.ev&quot;</span><span class="p">:</span>
                <span class="n">do_open</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Echoview application would</span><span class="si">{}</span><span class="s2"> be opened </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">do_open</span> <span class="k">else</span> <span class="s2">&quot; not&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;to convert EV files to CSV&quot;</span>
                    <span class="k">if</span> <span class="n">do_open</span>
                    <span class="k">else</span> <span class="s2">&quot;(no EV files to process)&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">do_open</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">common_notes</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classified by echofilter {ver} at {dt}</span>
<span class="sd">        Model checkpoint: {ckpt_name}</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ver</span><span class="o">=</span><span class="n">echofilter</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="s2">&quot;seconds&quot;</span><span class="p">),</span>
            <span class="n">ckpt_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ckpt_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">verbose</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">maybe_tqdm</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maybe_tqdm</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Files&quot;</span><span class="p">,</span> <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">skip_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">incompatible_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">error_msgs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Open Echoview connection</span>
    <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">maybe_open_echoview</span><span class="p">(</span>
        <span class="n">do_open</span><span class="o">=</span><span class="n">do_open</span><span class="p">,</span>
        <span class="n">minimize</span><span class="o">=</span><span class="n">minimize_echoview</span><span class="p">,</span>
        <span class="n">hide</span><span class="o">=</span><span class="n">hide_echoview</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">ev_app</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">maybe_tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">progress_fmt</span><span class="p">(</span>
                        <span class="s2">&quot;Processing </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">highlight_fmt</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Check what the full path should be</span>
            <span class="n">fname_full</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">determine_file_path</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">)</span>

            <span class="c1"># Determine where destination should be placed</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">determine_destination</span><span class="p">(</span>
                <span class="n">fname</span><span class="p">,</span> <span class="n">fname_full</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">,</span> <span class="n">output_dir</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_ext</span><span class="p">:</span>
                <span class="n">destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">destination</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Make a list of all the outputs we will produce</span>
            <span class="n">dest_files</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;turbulence&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;surface&quot;</span><span class="p">):</span>
                <span class="n">dest_files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}{}</span><span class="s2">.evl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">suffix_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">generate_turbulence_line</span><span class="p">:</span>
                <span class="n">dest_files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;turbulence&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">generate_bottom_line</span><span class="p">:</span>
                <span class="n">dest_files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">generate_surface_line</span><span class="p">:</span>
                <span class="n">dest_files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;surface&quot;</span><span class="p">)</span>
            <span class="n">dest_files</span><span class="p">[</span><span class="s2">&quot;regions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}{}</span><span class="s2">.evr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">destination</span><span class="p">,</span> <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="n">suffix_file</span>
            <span class="p">)</span>

            <span class="c1"># Check if any of them exists and if there is any missing</span>
            <span class="n">any_missing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">clobbers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">dest_file</span> <span class="ow">in</span> <span class="n">dest_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_file</span><span class="p">):</span>
                    <span class="n">clobbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest_file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">any_missing</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Check whether to skip processing this file</span>
            <span class="k">if</span> <span class="n">skip_existing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">any_missing</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">skip_fmt</span><span class="p">(</span><span class="s2">&quot;  Skipping </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)))</span>
                <span class="n">skip_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="c1"># Check whether we would clobber a file we can&#39;t overwrite</span>
            <span class="k">if</span> <span class="n">clobbers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite_existing</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Output &quot;</span> <span class="o">+</span> <span class="n">clobbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clobbers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;and 1 other &quot;</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">clobbers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  and </span><span class="si">{}</span><span class="s2"> others &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clobbers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;already exist</span><span class="si">{}</span><span class="s2"> for file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clobbers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">fname</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                        <span class="n">error_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Error: &quot;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="n">existing_file_msg</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">error_msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">continue</span>
                    <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="n">existing_file_msg</span><span class="p">)</span>

            <span class="c1"># Determine whether we need to run ev2csv on this file</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="n">process_as_ev</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;ev&quot;</span><span class="p">:</span>
                <span class="n">process_as_ev</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;csv&quot;</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
                <span class="n">process_as_ev</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;ev&quot;</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
                <span class="n">process_as_ev</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unsure how to process file </span><span class="si">{}</span><span class="s2"> with unrecognised extension </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_incompatible</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">skip_fmt</span><span class="p">(</span>
                            <span class="s2">&quot;  Skipping incompatible file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">incompatible_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c1"># If we are processing an ev file, we need to export it as a raw</span>
            <span class="c1"># csv file. Unless it has already been exported (which we will</span>
            <span class="c1"># check for below).</span>
            <span class="n">export_to_csv</span> <span class="o">=</span> <span class="n">process_as_ev</span>

            <span class="c1"># Make a temporary directory in case we are not caching generated csvs</span>
            <span class="c1"># Directory and all its contents are deleted when we leave this context</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>

                <span class="c1"># Convert ev file to csv, if necessary</span>
                <span class="n">ev2csv_dir</span> <span class="o">=</span> <span class="n">cache_csv</span>
                <span class="k">if</span> <span class="n">ev2csv_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ev2csv_dir</span> <span class="o">=</span> <span class="n">tmpdirname</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">export_to_csv</span><span class="p">:</span>
                    <span class="n">csv_fname</span> <span class="o">=</span> <span class="n">fname_full</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Determine where exported CSV file should be placed</span>
                    <span class="n">csv_fname</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">determine_destination</span><span class="p">(</span>
                        <span class="n">fname</span><span class="p">,</span> <span class="n">fname_full</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">,</span> <span class="n">ev2csv_dir</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_ext</span><span class="p">:</span>
                        <span class="n">csv_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">csv_fname</span> <span class="o">+=</span> <span class="n">suffix_csv</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">):</span>
                    <span class="c1"># If CSV file is already cached, no need to re-export it</span>
                    <span class="n">export_to_csv</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">export_to_csv</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;  Would export </span><span class="si">{}</span><span class="s2"> as CSV file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">fname_full</span><span class="p">,</span> <span class="n">csv_fname</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Import ev2csv now. We delay this import so Linux users</span>
                    <span class="c1"># without pywin32 can run on CSV files.</span>
                    <span class="kn">from</span> <span class="nn">echofilter.ev2csv</span> <span class="kn">import</span> <span class="n">ev2csv</span>

                    <span class="c1"># Export the CSV file</span>
                    <span class="n">fname_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fname_full</span><span class="p">)</span>
                    <span class="n">csv_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">)</span>
                    <span class="n">ev2csv</span><span class="p">(</span>
                        <span class="n">fname_full</span><span class="p">,</span>
                        <span class="n">csv_fname</span><span class="p">,</span>
                        <span class="n">variable_name</span><span class="o">=</span><span class="n">variable_name</span><span class="p">,</span>
                        <span class="n">ev_app</span><span class="o">=</span><span class="n">ev_app</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">ww</span> <span class="o">=</span> <span class="s2">&quot;Would&quot;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s2">&quot;Will&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2"> write files:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ww</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">dest_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">and</span> <span class="n">overwrite_existing</span><span class="p">:</span>
                            <span class="n">over_txt</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">overwrite_fmt</span><span class="p">(</span>
                                <span class="s2">&quot;(overwriting existing file)&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">over_txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tp</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.evl&quot;</span> <span class="k">else</span> <span class="s2">&quot;file&quot;</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;    </span><span class="si">{}</span><span class="s2"> export </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> to: </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">ww</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">over_txt</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Load the data</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timestamps</span><span class="p">,</span> <span class="n">depths</span><span class="p">,</span> <span class="n">signals</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">transect_loader</span><span class="p">(</span>
                        <span class="n">csv_fname</span><span class="p">,</span>
                        <span class="n">warn_row_overflow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">row_len_selector</span><span class="o">=</span><span class="n">row_len_selector</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">skip_incompatible</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_input</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">skip_fmt</span><span class="p">(</span>
                                    <span class="s2">&quot;  Skipping incompatible file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="n">incompatible_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;CSV file </span><span class="si">{}</span><span class="s2"> could not be loaded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">inference_transect</span><span class="p">(</span>
                    <span class="n">model</span><span class="p">,</span>
                    <span class="n">timestamps</span><span class="p">,</span>
                    <span class="n">depths</span><span class="p">,</span>
                    <span class="n">signals</span><span class="p">,</span>
                    <span class="n">device</span><span class="p">,</span>
                    <span class="n">image_height</span><span class="p">,</span>
                    <span class="n">facing</span><span class="o">=</span><span class="n">facing</span><span class="p">,</span>
                    <span class="n">crop_min_depth</span><span class="o">=</span><span class="n">crop_min_depth</span><span class="p">,</span>
                    <span class="n">crop_max_depth</span><span class="o">=</span><span class="n">crop_max_depth</span><span class="p">,</span>
                    <span class="n">autocrop_threshold</span><span class="o">=</span><span class="n">autocrop_threshold</span><span class="p">,</span>
                    <span class="n">force_unconditioned</span><span class="o">=</span><span class="n">force_unconditioned</span><span class="p">,</span>
                    <span class="n">data_center</span><span class="o">=</span><span class="n">center_param</span><span class="p">,</span>
                    <span class="n">data_deviation</span><span class="o">=</span><span class="n">deviation_param</span><span class="p">,</span>
                    <span class="n">nan_value</span><span class="o">=</span><span class="n">nan_value</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">continue_on_error</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_fmt</span><span class="p">(</span><span class="s2">&quot;An error has occurred:&quot;</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_fmt</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                <span class="n">error_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Generated model output with fields:&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_conditional_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_unconditioned</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;is_upward_facing&quot;</span><span class="p">]:</span>
                    <span class="n">cs</span> <span class="o">=</span> <span class="s2">&quot;|upfacing&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cs</span> <span class="o">=</span> <span class="s2">&quot;|downfacing&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">aside_fmt</span><span class="p">(</span>
                            <span class="s2">&quot;  Using conditional probability outputs from model:&quot;</span>
                            <span class="s2">&quot; p(state</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">is_conditional_model</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">aside_fmt</span><span class="p">(</span>
                            <span class="s2">&quot;Using unconditioned output from conditional model&quot;</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># Convert output into lines</span>
            <span class="n">surface_depths</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span>
                <span class="n">echofilter</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">last_nonzero</span><span class="p">(</span>
                    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;p_is_above_surface&quot;</span> <span class="o">+</span> <span class="n">cs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">turbulence_depths</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span>
                <span class="n">echofilter</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">last_nonzero</span><span class="p">(</span>
                    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;p_is_above_turbulence&quot;</span> <span class="o">+</span> <span class="n">cs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">bottom_depths</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span>
                <span class="n">echofilter</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">first_nonzero</span><span class="p">(</span>
                    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;p_is_below_bottom&quot;</span> <span class="o">+</span> <span class="n">cs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">]</span>

            <span class="n">line_timestamps</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">is_passive</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;p_is_passive&quot;</span> <span class="o">+</span> <span class="n">cs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
            <span class="k">if</span> <span class="n">lines_during_passive</span> <span class="o">==</span> <span class="s2">&quot;predict&quot;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">lines_during_passive</span> <span class="o">==</span> <span class="s2">&quot;redact&quot;</span><span class="p">:</span>
                <span class="n">surface_depths</span> <span class="o">=</span> <span class="n">surface_depths</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">]</span>
                <span class="n">turbulence_depths</span> <span class="o">=</span> <span class="n">turbulence_depths</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">]</span>
                <span class="n">bottom_depths</span> <span class="o">=</span> <span class="n">bottom_depths</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">]</span>
                <span class="n">line_timestamps</span> <span class="o">=</span> <span class="n">line_timestamps</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">lines_during_passive</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">:</span>
                <span class="n">surface_depths</span><span class="p">[</span><span class="n">is_passive</span><span class="p">]</span> <span class="o">=</span> <span class="n">EV_UNDEFINED_DEPTH</span>
                <span class="n">turbulence_depths</span><span class="p">[</span><span class="n">is_passive</span><span class="p">]</span> <span class="o">=</span> <span class="n">EV_UNDEFINED_DEPTH</span>
                <span class="n">bottom_depths</span><span class="p">[</span><span class="n">is_passive</span><span class="p">]</span> <span class="o">=</span> <span class="n">EV_UNDEFINED_DEPTH</span>
            <span class="k">elif</span> <span class="n">lines_during_passive</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;interp&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">lines_during_passive</span> <span class="o">==</span> <span class="s2">&quot;interpolate-time&quot;</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">line_timestamps</span>
                <span class="k">elif</span> <span class="n">lines_during_passive</span> <span class="o">==</span> <span class="s2">&quot;interpolate-index&quot;</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line_timestamps</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unsupported passive line interpolation method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">lines_during_passive</span>
                    <span class="p">)</span>
                    <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;Could not interpolate depths for passive data for&quot;</span>
                            <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">, as all data appears to be from passive&quot;</span>
                            <span class="s2">&quot; collection. The original model predictions will&quot;</span>
                            <span class="s2">&quot; be kept instead.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">surface_depths</span><span class="p">[</span><span class="n">is_passive</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">is_passive</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">],</span> <span class="n">surface_depths</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">turbulence_depths</span><span class="p">[</span><span class="n">is_passive</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">is_passive</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">],</span> <span class="n">turbulence_depths</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">bottom_depths</span><span class="p">[</span><span class="n">is_passive</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">is_passive</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">],</span> <span class="n">bottom_depths</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unsupported passive line method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lines_during_passive</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;is_upward_facing&quot;</span><span class="p">]:</span>
                <span class="n">nearfield_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span> <span class="o">-</span> <span class="n">nearfield</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nearfield_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span> <span class="o">+</span> <span class="n">nearfield</span>

            <span class="c1"># Export evl files</span>
            <span class="n">destination_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">destination_dir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line_name</span><span class="p">,</span> <span class="n">line_depths</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;turbulence&quot;</span><span class="p">,</span> <span class="n">turbulence_depths</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">bottom_depths</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;surface&quot;</span><span class="p">,</span> <span class="n">surface_depths</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">line_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dest_files</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">dest_file</span> <span class="o">=</span> <span class="n">dest_files</span><span class="p">[</span><span class="n">line_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;  Writing output&quot;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_file</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">overwrite_existing</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">overwrite_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_file</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite_existing</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Output </span><span class="si">{}</span><span class="s2"> already exists.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_file</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="n">existing_file_msg</span><span class="p">)</span>

                <span class="n">echofilter</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">evl_writer</span><span class="p">(</span>
                    <span class="n">dest_file</span><span class="p">,</span>
                    <span class="n">line_timestamps</span><span class="p">,</span>
                    <span class="n">line_depths</span><span class="p">,</span>
                    <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">line_status</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Export evr file</span>
            <span class="n">dest_file</span> <span class="o">=</span> <span class="n">dest_files</span><span class="p">[</span><span class="s2">&quot;regions&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;  Writing output&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_file</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">overwrite_existing</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">overwrite_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite_existing</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Output </span><span class="si">{}</span><span class="s2"> already exists.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_file</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="n">existing_file_msg</span><span class="p">)</span>

            <span class="n">patches_key</span> <span class="o">=</span> <span class="s2">&quot;p_is_patch&quot;</span>
            <span class="k">if</span> <span class="n">patch_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;is_upward_facing&quot;</span><span class="p">]:</span>
                    <span class="n">patches_key</span> <span class="o">+=</span> <span class="s2">&quot;-ntob&quot;</span>
            <span class="k">elif</span> <span class="n">patch_mode</span> <span class="o">!=</span> <span class="s2">&quot;merged&quot;</span><span class="p">:</span>
                <span class="n">patches_key</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">patch_mode</span>

            <span class="n">echofilter</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">write_transect_regions</span><span class="p">(</span>
                <span class="n">dest_file</span><span class="p">,</span>
                <span class="n">output</span><span class="p">,</span>
                <span class="n">depth_range</span><span class="o">=</span><span class="n">depths</span><span class="p">,</span>
                <span class="n">passive_key</span><span class="o">=</span><span class="s2">&quot;p_is_passive&quot;</span> <span class="o">+</span> <span class="n">cs</span><span class="p">,</span>
                <span class="n">removed_key</span><span class="o">=</span><span class="s2">&quot;p_is_removed&quot;</span> <span class="o">+</span> <span class="n">cs</span><span class="p">,</span>
                <span class="n">patches_key</span><span class="o">=</span><span class="n">patches_key</span> <span class="o">+</span> <span class="n">cs</span><span class="p">,</span>
                <span class="n">collate_passive_length</span><span class="o">=</span><span class="n">collate_passive_length</span><span class="p">,</span>
                <span class="n">collate_removed_length</span><span class="o">=</span><span class="n">collate_removed_length</span><span class="p">,</span>
                <span class="n">minimum_passive_length</span><span class="o">=</span><span class="n">minimum_passive_length</span><span class="p">,</span>
                <span class="n">minimum_removed_length</span><span class="o">=</span><span class="n">minimum_removed_length</span><span class="p">,</span>
                <span class="n">minimum_patch_area</span><span class="o">=</span><span class="n">minimum_patch_area</span><span class="p">,</span>
                <span class="n">name_suffix</span><span class="o">=</span><span class="n">suffix_var</span><span class="p">,</span>
                <span class="n">common_notes</span><span class="o">=</span><span class="n">common_notes</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">verbose_indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">process_as_ev</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">import_into_evfile</span><span class="p">:</span>
                <span class="c1"># Done with processing this file</span>
                <span class="k">continue</span>

            <span class="n">target_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">key</span> <span class="o">+</span> <span class="n">suffix_var</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dest_files</span><span class="p">}</span>
            <span class="n">target_names</span><span class="p">[</span><span class="s2">&quot;nearfield&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nearfield&quot;</span> <span class="o">+</span> <span class="n">suffix_var</span>

            <span class="n">offsets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">turbulence</span><span class="o">=</span><span class="n">offset_turbulence</span><span class="p">,</span>
                <span class="n">bottom</span><span class="o">=</span><span class="n">offset_bottom</span><span class="p">,</span>
                <span class="n">surface</span><span class="o">=</span><span class="n">offset_surface</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">lines_cutoff_at_nearfield</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;is_upward_facing&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">cutoff_at_nearfield</span> <span class="ow">or</span> <span class="n">cutoff_at_nearfield</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lines_cutoff_at_nearfield</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">cutoff_at_nearfield</span><span class="p">:</span>
                <span class="n">lines_cutoff_at_nearfield</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;turbulence&quot;</span><span class="p">]</span>

            <span class="n">import_lines_regions_to_ev</span><span class="p">(</span>
                <span class="n">fname_full</span><span class="p">,</span>
                <span class="n">dest_files</span><span class="p">,</span>
                <span class="n">target_names</span><span class="o">=</span><span class="n">target_names</span><span class="p">,</span>
                <span class="n">nearfield_depth</span><span class="o">=</span><span class="n">nearfield_depth</span><span class="p">,</span>
                <span class="n">add_nearfield_line</span><span class="o">=</span><span class="n">add_nearfield_line</span><span class="p">,</span>
                <span class="n">lines_cutoff_at_nearfield</span><span class="o">=</span><span class="n">lines_cutoff_at_nearfield</span><span class="p">,</span>
                <span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span>
                <span class="n">line_colors</span><span class="o">=</span><span class="n">line_colors</span><span class="p">,</span>
                <span class="n">line_thicknesses</span><span class="o">=</span><span class="n">line_thicknesses</span><span class="p">,</span>
                <span class="n">ev_app</span><span class="o">=</span><span class="n">ev_app</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite_ev_lines</span><span class="p">,</span>
                <span class="n">common_notes</span><span class="o">=</span><span class="n">common_notes</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">progress_fmt</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Finished </span><span class="si">{}</span><span class="s2">processing </span><span class="si">{}</span><span class="s2"> file</span><span class="si">{}{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">HighlightStyle</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                    <span class="s2">&quot;simulating &quot;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span>
                    <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span>
                    <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">HighlightStyle</span><span class="o">.</span><span class="n">reset</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">skip_total</span> <span class="o">=</span> <span class="n">skip_count</span> <span class="o">+</span> <span class="n">incompatible_count</span>
        <span class="k">if</span> <span class="n">skip_total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Of these, </span><span class="si">{}{}{}</span><span class="s2"> file</span><span class="si">{}</span><span class="s2"> skipped</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> already processed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;all &quot;</span> <span class="k">if</span> <span class="n">skip_total</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">HighlightStyle</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                <span class="n">skip_total</span><span class="p">,</span>
                <span class="s2">&quot; was&quot;</span> <span class="k">if</span> <span class="n">skip_total</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;s were&quot;</span><span class="p">,</span>
                <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">HighlightStyle</span><span class="o">.</span><span class="n">reset</span><span class="p">,</span>
                <span class="n">skip_count</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;, </span><span class="si">{}</span><span class="s2"> incompatible&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">incompatible_count</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">skip_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error_msgs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_fmt</span><span class="p">(</span>
                    <span class="s2">&quot;There </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> error</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s2">&quot;was&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_msgs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;were&quot;</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">error_msgs</span><span class="p">),</span>
                        <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_msgs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">error_msg</span> <span class="ow">in</span> <span class="n">error_msgs</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_fmt</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Total runtime: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start_prog</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="inference_transect"><a class="viewcode-back" href="../../source/packages/echofilter.html#echofilter.inference.inference_transect">[docs]</a><span class="k">def</span> <span class="nf">inference_transect</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">timestamps</span><span class="p">,</span>
    <span class="n">depths</span><span class="p">,</span>
    <span class="n">signals</span><span class="p">,</span>
    <span class="n">device</span><span class="p">,</span>
    <span class="n">image_height</span><span class="p">,</span>
    <span class="n">facing</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">crop_min_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">crop_max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">autocrop_threshold</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
    <span class="n">force_unconditioned</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">data_center</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="n">data_deviation</span><span class="o">=</span><span class="s2">&quot;stdev&quot;</span><span class="p">,</span>
    <span class="n">nan_value</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run inference on a single transect.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : echofilter.wrapper.Echofilter</span>
<span class="sd">        A pytorch Module wrapped in an Echofilter UI layer.</span>
<span class="sd">    timestamps : array_like</span>
<span class="sd">        Sample recording timestamps (in seconds since Unix epoch). Must be a</span>
<span class="sd">        vector.</span>
<span class="sd">    depths : array_like</span>
<span class="sd">        Recording depths from the surface (in metres). Must be a vector.</span>
<span class="sd">    signals : array_like</span>
<span class="sd">        Echogram Sv data. Must be a matrix shaped</span>
<span class="sd">        `(len(timestamps), len(depths))`.</span>
<span class="sd">    image_height : int</span>
<span class="sd">        Height to resize echogram before passing through model.</span>
<span class="sd">    facing : {&quot;downward&quot;, &quot;upward&quot;, &quot;auto&quot;}, optional</span>
<span class="sd">        Orientation in which the echosounder is facing. Default is `&quot;auto&quot;`,</span>
<span class="sd">        in which case the orientation is determined from the ordering of the</span>
<span class="sd">        depth values in the data (increasing = `&quot;upward&quot;`,</span>
<span class="sd">        decreasing = `&quot;downward&quot;`).</span>
<span class="sd">    crop_min_depth : float or None, optional</span>
<span class="sd">        Minimum depth to include in input. If `None` (default), there is no</span>
<span class="sd">        minimum depth.</span>
<span class="sd">    crop_max_depth : float or None, optional</span>
<span class="sd">        Maxmimum depth to include in input. If `None` (default), there is no</span>
<span class="sd">        maximum depth.</span>
<span class="sd">    autocrop_threshold : float, optional</span>
<span class="sd">        Minimum fraction of input height which must be found to be removable</span>
<span class="sd">        for the model to be re-run with an automatically cropped input.</span>
<span class="sd">        Default is 0.35.</span>
<span class="sd">    force_unconditioned : bool, optional</span>
<span class="sd">        Whether to always use unconditioned logit outputs when deteriming the</span>
<span class="sd">        new depth range for automatic cropping.</span>
<span class="sd">    data_center : float or str, optional</span>
<span class="sd">        Center point to use, which will be subtracted from the Sv signals</span>
<span class="sd">        (i.e. the overall sample mean).</span>
<span class="sd">        If `data_center` is a string, it specifies the method to use to</span>
<span class="sd">        determine the center value from the distribution of intensities seen</span>
<span class="sd">        in this sample transect. Default is `&quot;mean&quot;`.</span>
<span class="sd">    data_deviation : float or str, optional</span>
<span class="sd">        Deviation to use to normalise the Sv signals in divisive manner</span>
<span class="sd">        (i.e. the overall sample standard deviation).</span>
<span class="sd">        If `data_deviation` is a string, it specifies the method to use to</span>
<span class="sd">        determine the center value from the distribution of intensities seen</span>
<span class="sd">        in this sample transect. Default is `&quot;stdev&quot;`.</span>
<span class="sd">    nan_value : float, optional</span>
<span class="sd">        Placeholder value to replace NaNs with. Default is `-3`.</span>
<span class="sd">    dtype : torch.dtype, optional</span>
<span class="sd">        Datatype to use for model input. Default is `torch.float`.</span>
<span class="sd">    verbose : int, optional</span>
<span class="sd">        Level of verbosity. Default is `0`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with fields as output by `echofilter.wrapper.Echofilter`,</span>
<span class="sd">        plus `timestamps` and `depths`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">facing</span> <span class="o">=</span> <span class="n">facing</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span>
    <span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span>
    <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>
    <span class="n">transect</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;timestamps&quot;</span><span class="p">:</span> <span class="n">timestamps</span><span class="p">,</span>
        <span class="s2">&quot;depths&quot;</span><span class="p">:</span> <span class="n">depths</span><span class="p">,</span>
        <span class="s2">&quot;signals&quot;</span><span class="p">:</span> <span class="n">signals</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">crop_min_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Apply minimum depth crop</span>
        <span class="n">depth_crop_mask</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">crop_min_depth</span>
        <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span><span class="n">depth_crop_mask</span><span class="p">]</span>
        <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">][:,</span> <span class="n">depth_crop_mask</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">crop_max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Apply maximum depth crop</span>
        <span class="n">depth_crop_mask</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">crop_max_depth</span>
        <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span><span class="n">depth_crop_mask</span><span class="p">]</span>
        <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">][:,</span> <span class="n">depth_crop_mask</span><span class="p">]</span>

    <span class="c1"># Standardize data distribution</span>
    <span class="n">transect</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">data_center</span><span class="p">,</span> <span class="n">data_deviation</span><span class="p">)(</span>
        <span class="n">transect</span>
    <span class="p">)</span>

    <span class="c1"># Configure data to match what the model expects to see</span>
    <span class="c1"># Determine whether depths are ascending or descending</span>
    <span class="n">is_upward_facing</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Ensure depth is always increasing (which corresponds to descending from</span>
    <span class="c1"># the air down the water column)</span>
    <span class="k">if</span> <span class="n">facing</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">facing</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="ow">and</span> <span class="n">is_upward_facing</span><span class="p">):</span>
        <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">facing</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">aside_fmt</span><span class="p">(</span>
                    <span class="s2">&quot;  Echogram was autodetected as upward facing, and was flipped&quot;</span>
                    <span class="s2">&quot; vertically before being input into the model.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_upward_facing</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;  Warning: facing = &quot;</span><span class="si">{}</span><span class="s1">&quot; was provided, but data appears to be&#39;</span>
                <span class="s2">&quot; downward facing&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">facing</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">is_upward_facing</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">facing</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;down&quot;</span> <span class="ow">and</span> <span class="n">facing</span> <span class="o">!=</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;facing should be one of &quot;downward&quot;, &quot;upward&quot;, and &quot;auto&quot;&#39;</span>
        <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">facing</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;down&quot;</span> <span class="ow">and</span> <span class="n">is_upward_facing</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;  Warning: facing = &quot;</span><span class="si">{}</span><span class="s1">&quot; was provided, but data appears to be&#39;</span>
            <span class="s2">&quot; upward facing&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">facing</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">is_upward_facing</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">facing</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">aside_fmt</span><span class="p">(</span>
                <span class="s2">&quot;  Echogram was autodetected as downward facing.&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># To reduce memory consumption, split into segments whenever the recording</span>
    <span class="c1"># interval is longer than normal</span>
    <span class="n">segments</span> <span class="o">=</span> <span class="n">split_transect</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1280</span><span class="p">,</span> <span class="o">**</span><span class="n">transect</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">maybe_tqdm</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;  Segments&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maybe_tqdm</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">maybe_tqdm</span><span class="p">(</span><span class="n">segments</span><span class="p">):</span>
        <span class="c1"># Try to remove any NaNs in the raw input with using 2d interpolation</span>
        <span class="n">n_nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">n_nans</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Interpolating to fill in </span><span class="si">{}</span><span class="s2"> missing Sv values&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_nans</span><span class="p">))</span>
            <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fillholes2d</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">])</span>

        <span class="c1"># Preprocessing transform</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">echofilter</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ReplaceNan</span><span class="p">(</span><span class="n">nan_value</span><span class="p">),</span>
                <span class="n">echofilter</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Rescale</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image_height</span><span class="p">),</span>
                    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">segment</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="c1"># Put data through model</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output_device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">]</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">]</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;_pad_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;_pad_start&quot;</span><span class="p">]</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;_pad_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;_pad_end&quot;</span><span class="p">]</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">join_transect</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;is_upward_facing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_upward_facing</span>

    <span class="k">if</span> <span class="n">autocrop_threshold</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># If we are not doing auto-crop, return the current output</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="c1"># See how much of the depth we could crop away</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;conditional&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_unconditioned</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;is_upward_facing&quot;</span><span class="p">]:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="s2">&quot;|upfacing&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="s2">&quot;|downfacing&quot;</span>
    <span class="n">is_passive</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;p_is_passive&quot;</span> <span class="o">+</span> <span class="n">cs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
    <span class="n">depth_intv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">is_upward_facing</span><span class="p">:</span>
        <span class="c1"># Restrict the top based on the observed surface depths</span>
        <span class="n">surface_depths</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span>
            <span class="n">echofilter</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">last_nonzero</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;p_is_above_surface&quot;</span> <span class="o">+</span> <span class="n">cs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># Redact passive regions</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surface_depths</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">surface_depths</span> <span class="o">=</span> <span class="n">surface_depths</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">]</span>
        <span class="c1"># Find a good estimator of the maximum. Go for a robust estimate of</span>
        <span class="c1"># four sigma from the middle.</span>
        <span class="n">pct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">surface_depths</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.275</span><span class="p">,</span> <span class="mf">97.725</span><span class="p">])</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">pct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pct</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="n">new_crop_min</span> <span class="o">=</span> <span class="n">pct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dev</span>
        <span class="c1"># Don&#39;t go higher than the minimum of the predicted surface depths</span>
        <span class="n">new_crop_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">new_crop_min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">surface_depths</span><span class="p">))</span>
        <span class="c1"># Offset minimum by at least 2m, to be sure we are capturing enough</span>
        <span class="c1"># surrounding content.</span>
        <span class="n">new_crop_min</span> <span class="o">-=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">depth_intv</span><span class="p">)</span>
        <span class="n">new_crop_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_crop_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">])</span>
        <span class="c1"># Restrict the bottom based on the observed bottom depths</span>
        <span class="n">bottom_depths</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span>
            <span class="n">echofilter</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">first_nonzero</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;p_is_below_bottom&quot;</span> <span class="o">+</span> <span class="n">cs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># Redact passive regions</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bottom_depths</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bottom_depths</span> <span class="o">=</span> <span class="n">bottom_depths</span><span class="p">[</span><span class="o">~</span><span class="n">is_passive</span><span class="p">]</span>
        <span class="c1"># Find a good estimator of the maximum. Go for a robust estimate of</span>
        <span class="c1"># four sigma from the middle.</span>
        <span class="n">pct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bottom_depths</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.275</span><span class="p">,</span> <span class="mf">97.725</span><span class="p">])</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">pct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pct</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="n">new_crop_max</span> <span class="o">=</span> <span class="n">pct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dev</span>
        <span class="c1"># Don&#39;t go deeper than the maximum of the predicted bottom depths</span>
        <span class="n">new_crop_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_crop_max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bottom_depths</span><span class="p">))</span>
        <span class="c1"># Offset maximum by at least 2m, to be sure we are capturing enough</span>
        <span class="c1"># surrounding content.</span>
        <span class="n">new_crop_max</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">depth_intv</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">crop_min_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_crop_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">new_crop_min</span><span class="p">,</span> <span class="n">crop_min_depth</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">crop_max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_crop_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_crop_max</span><span class="p">,</span> <span class="n">crop_max_depth</span><span class="p">)</span>

    <span class="n">current_height</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">transect</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">new_height</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">new_crop_max</span> <span class="o">-</span> <span class="n">new_crop_min</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">current_height</span> <span class="o">-</span> <span class="n">new_height</span><span class="p">)</span> <span class="o">/</span> <span class="n">current_height</span> <span class="o">&lt;=</span> <span class="n">autocrop_threshold</span><span class="p">:</span>
        <span class="c1"># No need to crop</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;  Automatically zooming in on the </span><span class="si">{:.2f}</span><span class="s2">m to </span><span class="si">{:.2f}</span><span class="s2">m depth range&quot;</span>
            <span class="s2">&quot; and re-doing model inference.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_crop_min</span><span class="p">,</span> <span class="n">new_crop_max</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Crop and run again; and don&#39;t autocrop a second time!</span>
    <span class="k">return</span> <span class="n">inference_transect</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">timestamps</span><span class="p">,</span>
        <span class="n">depths</span><span class="p">,</span>
        <span class="n">signals</span><span class="p">,</span>
        <span class="n">device</span><span class="p">,</span>
        <span class="n">image_height</span><span class="p">,</span>
        <span class="n">facing</span><span class="o">=</span><span class="n">facing</span><span class="p">,</span>
        <span class="n">crop_min_depth</span><span class="o">=</span><span class="n">new_crop_min</span><span class="p">,</span>
        <span class="n">crop_max_depth</span><span class="o">=</span><span class="n">new_crop_max</span><span class="p">,</span>
        <span class="n">autocrop_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Don&#39;t crop again</span>
        <span class="n">force_unconditioned</span><span class="o">=</span><span class="n">force_unconditioned</span><span class="p">,</span>
        <span class="n">data_center</span><span class="o">=</span><span class="n">data_center</span><span class="p">,</span>
        <span class="n">data_deviation</span><span class="o">=</span><span class="n">data_deviation</span><span class="p">,</span>
        <span class="n">nan_value</span><span class="o">=</span><span class="n">nan_value</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="import_lines_regions_to_ev"><a class="viewcode-back" href="../../source/packages/echofilter.html#echofilter.inference.import_lines_regions_to_ev">[docs]</a><span class="k">def</span> <span class="nf">import_lines_regions_to_ev</span><span class="p">(</span>
    <span class="n">ev_fname</span><span class="p">,</span>
    <span class="n">files</span><span class="p">,</span>
    <span class="n">target_names</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">nearfield_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">add_nearfield_line</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">lines_cutoff_at_nearfield</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">offsets</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">line_colors</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">line_thicknesses</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">ev_app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">common_notes</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write lines and regions to EV file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ev_fname : str</span>
<span class="sd">        Path to Echoview file to import variables into.</span>
<span class="sd">    files : dict</span>
<span class="sd">        Mapping from output keys to filenames.</span>
<span class="sd">    target_names : dict, optional</span>
<span class="sd">        Mapping from output keys to output variable names.</span>
<span class="sd">    nearfield_depth : float or None, optional</span>
<span class="sd">        Depth at which nearfield line will be placed. If `None` (default), no</span>
<span class="sd">        nearfield line will be added, irrespective of `add_nearfield_line`.</span>
<span class="sd">    add_nearfield_line : bool, optional</span>
<span class="sd">        Whether to add a nearfield line. Default is `True`.</span>
<span class="sd">    lines_cutoff_at_nearfield : list of str, optional</span>
<span class="sd">        Which lines (if any) should be clipped at the nearfield depth.</span>
<span class="sd">        Default is `[]`.</span>
<span class="sd">    offsets : dict, optional</span>
<span class="sd">        Amount of offset for each line.</span>
<span class="sd">    line_colors : dict, optional</span>
<span class="sd">        Mapping from output keys to line colours.</span>
<span class="sd">    line_thicknesses : dict, optional</span>
<span class="sd">        Mapping from output keys to line thicknesses.</span>
<span class="sd">    ev_app : win32com.client.Dispatch object or None, optional</span>
<span class="sd">        An object which can be used to interface with the Echoview application,</span>
<span class="sd">        as returned by `win32com.client.Dispatch`. If `None` (default), a</span>
<span class="sd">        new instance of the application is opened (and closed on completion).</span>
<span class="sd">    overwrite : bool, optional</span>
<span class="sd">        Whether existing lines with target names should be replaced.</span>
<span class="sd">        If a line with the target name already exists and `overwrite=False`,</span>
<span class="sd">        the line is named with the current datetime to prevent collisions.</span>
<span class="sd">        Default is `False`.</span>
<span class="sd">    common_notes : str, optional</span>
<span class="sd">        Notes to include for every region. Default is `&quot;&quot;`.</span>
<span class="sd">    verbose : int, optional</span>
<span class="sd">        Verbosity level. Default is `1`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Importing </span><span class="si">{}</span><span class="s2"> lines/regions into EV file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">ev_fname</span><span class="p">))</span>

    <span class="c1"># Assemble the color palette</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">get_color_palette</span><span class="p">()</span>

    <span class="n">dtstr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="s2">&quot;seconds&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">open_ev_file</span><span class="p">(</span><span class="n">ev_fname</span><span class="p">,</span> <span class="n">ev_app</span><span class="p">)</span> <span class="k">as</span> <span class="n">ev_file</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">change_line_color_thickness</span><span class="p">(</span><span class="n">line_name</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="p">,</span> <span class="n">ev_app</span><span class="o">=</span><span class="n">ev_app</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">thickness</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ev_app</span><span class="o">.</span><span class="n">Exec</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> | UseDefaultLineDisplaySettings =| false&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">color</span><span class="p">]</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="s2">&quot;xkcd:&quot;</span> <span class="o">+</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="s2">&quot;xkcd:&quot;</span> <span class="o">+</span> <span class="n">color</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">hexcolor2rgb8</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">color</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">ev_app</span><span class="o">.</span><span class="n">Exec</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> | CustomGoodLineColor =| </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_name</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">thickness</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ev_app</span><span class="o">.</span><span class="n">Exec</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> | CustomLineDisplayThickness =| </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_name</span><span class="p">,</span> <span class="n">thickness</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Check the file exists</span>
            <span class="n">fname_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname_full</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;  Warning: File &#39;</span><span class="si">{}</span><span class="s2">&#39; could not be found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname_full</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;.evl&quot;</span><span class="p">:</span>
                <span class="c1"># Import regions from the EVR file</span>
                <span class="n">is_imported</span> <span class="o">=</span> <span class="n">ev_file</span><span class="o">.</span><span class="n">Import</span><span class="p">(</span><span class="n">fname_full</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_imported</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;  Warning: Unable to import file &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
                        <span class="s2">&quot;Please consult Echoview for the Import error message.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">fname</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Import the line into Python now. We might need it now for</span>
            <span class="c1"># clipping, or later on for offsetting.</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">depths</span><span class="p">,</span> <span class="n">statuses</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">evl_loader</span><span class="p">(</span>
                <span class="n">fname_full</span><span class="p">,</span> <span class="n">return_status</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">line_status</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">statuses</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nearfield_depth</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines_cutoff_at_nearfield</span><span class="p">:</span>
                <span class="c1"># Import the original line straight into Echoview</span>
                <span class="n">fname_loaded</span> <span class="o">=</span> <span class="n">fname_full</span>
                <span class="n">is_imported</span> <span class="o">=</span> <span class="n">ev_file</span><span class="o">.</span><span class="n">Import</span><span class="p">(</span><span class="n">fname_loaded</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Edit the line, clipping as necessary</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bottom&quot;</span><span class="p">:</span>
                    <span class="n">depths_clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">depths</span><span class="p">,</span> <span class="n">nearfield_depth</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">depths_clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">depths</span><span class="p">,</span> <span class="n">nearfield_depth</span><span class="p">)</span>

                <span class="c1"># Export the edited line to a temporary file</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
                    <span class="n">temp_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">echofilter</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">evl_writer</span><span class="p">(</span>
                        <span class="n">temp_fname</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">depths_clipped</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">line_status</span>
                    <span class="p">)</span>
                    <span class="c1"># Import the edited line into the EV file</span>
                    <span class="n">fname_loaded</span> <span class="o">=</span> <span class="n">temp_fname</span>
                    <span class="n">is_imported</span> <span class="o">=</span> <span class="n">ev_file</span><span class="o">.</span><span class="n">Import</span><span class="p">(</span><span class="n">fname_loaded</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_imported</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;  Warning: Unable to import file &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
                    <span class="s2">&quot;Please consult Echoview for the Import error message.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">fname_loaded</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Identify line just imported, which is the last variable</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">ev_file</span><span class="o">.</span><span class="n">Variables</span><span class="p">[</span><span class="n">ev_file</span><span class="o">.</span><span class="n">Variables</span><span class="o">.</span><span class="n">Count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">ev_file</span><span class="o">.</span><span class="n">Lines</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">FindByName</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;  Warning: Could not find line which was just imported with&quot;</span>
                    <span class="s2">&quot; name &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Ignoring and continuing processing.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Check whether we need to change the name of the line</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="n">target_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Check if a line with this name already exists</span>
            <span class="n">old_line</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">target_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lines</span><span class="o">.</span><span class="n">FindByName</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>

            <span class="c1"># Maybe try to overwrite existing line with new line</span>
            <span class="n">successful_overwrite</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">old_line</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="c1"># Overwrite the old line</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">overwrite_fmt</span><span class="p">(</span>
                            <span class="s2">&quot;Overwriting existing line &#39;</span><span class="si">{}</span><span class="s2">&#39; with new </span><span class="si">{}</span><span class="s2"> line&quot;</span>
                            <span class="s2">&quot; output&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">old_line_edit</span> <span class="o">=</span> <span class="n">old_line</span><span class="o">.</span><span class="n">AsLineEditable</span>
                <span class="k">if</span> <span class="n">old_line_edit</span><span class="p">:</span>
                    <span class="c1"># Overwrite the old line with the new line</span>
                    <span class="n">old_line_edit</span><span class="o">.</span><span class="n">OverwriteWith</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="c1"># Delete the line we imported</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="c1"># Update our reference to the line</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">old_line</span>
                    <span class="n">successful_overwrite</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Line is not editable</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Existing line &#39;</span><span class="si">{}</span><span class="s2">&#39; is not editable and cannot be&quot;</span>
                        <span class="s2">&quot; overwritten.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">old_line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">successful_overwrite</span><span class="p">:</span>
                <span class="c1"># Change the name so there is no collision</span>
                <span class="n">target_name</span> <span class="o">+=</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtstr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Target line name &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists. Will save&quot;</span>
                        <span class="s2">&quot; new </span><span class="si">{}</span><span class="s2"> line with name &#39;</span><span class="si">{}</span><span class="s2">&#39; instead.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">target_names</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">target_name</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">target_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">successful_overwrite</span><span class="p">:</span>
                <span class="c1"># Rename the line</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">ShortName</span> <span class="o">=</span> <span class="n">target_name</span>
                <span class="n">line</span><span class="o">.</span><span class="n">Name</span> <span class="o">=</span> <span class="n">target_name</span>

            <span class="c1"># Change the color and thickness of the line</span>
            <span class="n">change_line_color_thickness</span><span class="p">(</span>
                <span class="n">line</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">line_thicknesses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Add notes to the line</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; line&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_notes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">notes</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">common_notes</span>
            <span class="n">ev_app</span><span class="o">.</span><span class="n">Exec</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> | Notes =| </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1">## Handle offset line ---------------------------------------------</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">offsets</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Remember references to original line</span>
            <span class="n">original_line</span> <span class="o">=</span> <span class="n">line</span>
            <span class="n">original_target_name</span> <span class="o">=</span> <span class="n">target_name</span>

            <span class="c1"># Generate an offset line</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bottom&quot;</span><span class="p">:</span>
                <span class="c1"># Offset is upward for bottom line, downward otherwise</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">offset</span>
            <span class="n">depths_offset</span> <span class="o">=</span> <span class="n">depths</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="k">if</span> <span class="n">nearfield_depth</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines_cutoff_at_nearfield</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bottom&quot;</span><span class="p">:</span>
                <span class="n">depths_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">depths_offset</span><span class="p">,</span> <span class="n">nearfield_depth</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">depths_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">depths_offset</span><span class="p">,</span> <span class="n">nearfield_depth</span><span class="p">)</span>

            <span class="c1"># Export the edited line to a temporary file</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
                <span class="n">fname_noext</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">temp_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">tmpdirname</span><span class="p">,</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname_noext</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_offset&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">echofilter</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">evl_writer</span><span class="p">(</span>
                    <span class="n">temp_fname</span><span class="p">,</span>
                    <span class="n">ts</span><span class="p">,</span>
                    <span class="n">depths_offset</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">line_status</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Import the edited line into the EV file</span>
                <span class="n">is_imported</span> <span class="o">=</span> <span class="n">ev_file</span><span class="o">.</span><span class="n">Import</span><span class="p">(</span><span class="n">temp_fname</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_imported</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;  Warning: Unable to import file &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
                    <span class="s2">&quot;Please consult Echoview for the Import error message.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">temp_fname</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Identify line just imported, which is the last variable</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">ev_file</span><span class="o">.</span><span class="n">Variables</span><span class="p">[</span><span class="n">ev_file</span><span class="o">.</span><span class="n">Variables</span><span class="o">.</span><span class="n">Count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">FindByName</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>  <span class="c1"># Reference to new, offset, line</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;  Warning: Could not find line which was just imported with&quot;</span>
                    <span class="s2">&quot; name &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Ignoring and continuing processing.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Work out what we should call our new line</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="n">target_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_offset&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target_name</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">original_target_name</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">original_line</span><span class="o">.</span><span class="n">Name</span><span class="p">:</span>
                <span class="n">target_name</span> <span class="o">=</span> <span class="n">original_line</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;-offset&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">target_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">target_name</span> <span class="o">=</span> <span class="n">target_names</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;-offset&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_name</span> <span class="o">=</span> <span class="n">original_line</span><span class="o">.</span><span class="n">Name</span> <span class="o">+</span> <span class="s2">&quot;-offset&quot;</span>

            <span class="c1"># Check if a line with this name already exists</span>
            <span class="n">old_line</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">target_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lines</span><span class="o">.</span><span class="n">FindByName</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>

            <span class="c1"># Maybe try to overwrite existing line with new line</span>
            <span class="n">successful_overwrite</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">old_line</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="c1"># Overwrite the old line</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">overwrite_fmt</span><span class="p">(</span>
                            <span class="s2">&quot;Overwriting existing line &#39;</span><span class="si">{}</span><span class="s2">&#39; with new </span><span class="si">{}</span><span class="s2"> line&quot;</span>
                            <span class="s2">&quot; output&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">old_line_edit</span> <span class="o">=</span> <span class="n">old_line</span><span class="o">.</span><span class="n">AsLineEditable</span>
                <span class="k">if</span> <span class="n">old_line_edit</span><span class="p">:</span>
                    <span class="c1"># Overwrite the old line with the new line</span>
                    <span class="n">old_line_edit</span><span class="o">.</span><span class="n">OverwriteWith</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="c1"># Delete the line we imported</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="c1"># Update our reference to the line</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">old_line</span>
                    <span class="n">successful_overwrite</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Line is not editable</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Existing line &#39;</span><span class="si">{}</span><span class="s2">&#39; is not editable and cannot be&quot;</span>
                        <span class="s2">&quot; overwritten.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">old_line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">successful_overwrite</span><span class="p">:</span>
                <span class="c1"># Change the name so there is no collision</span>
                <span class="n">target_name</span> <span class="o">+=</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtstr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Target line name &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists. Will save&quot;</span>
                        <span class="s2">&quot; new </span><span class="si">{}</span><span class="s2"> line with name &#39;</span><span class="si">{}</span><span class="s2">&#39; instead.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">target_names</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">target_name</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">target_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">successful_overwrite</span><span class="p">:</span>
                <span class="c1"># Rename the line</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">ShortName</span> <span class="o">=</span> <span class="n">target_name</span>
                <span class="n">line</span><span class="o">.</span><span class="n">Name</span> <span class="o">=</span> <span class="n">target_name</span>

            <span class="c1"># Change the color and thickness of the line</span>
            <span class="n">change_line_color_thickness</span><span class="p">(</span>
                <span class="n">line</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">line_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_offset&quot;</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span>
                <span class="n">line_thicknesses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_offset&quot;</span><span class="p">,</span> <span class="n">line_thicknesses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="c1"># Add notes to the line</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> line</span><span class="se">\n</span><span class="s2">Offset: </span><span class="si">{:+g}</span><span class="s2">m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="n">offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_notes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">notes</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">common_notes</span>
            <span class="n">ev_app</span><span class="o">.</span><span class="n">Exec</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> | Notes =| </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="c1"># Add nearfield line</span>
        <span class="k">if</span> <span class="n">nearfield_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">add_nearfield_line</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;nearfield&quot;</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">ev_file</span><span class="o">.</span><span class="n">Lines</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">CreateFixedDepth</span><span class="p">(</span><span class="n">nearfield_depth</span><span class="p">)</span>

            <span class="c1"># Check whether we need to change the name of the line</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="n">target_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Check if a line with this name already exists</span>
            <span class="n">old_line</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">target_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lines</span><span class="o">.</span><span class="n">FindByName</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>

            <span class="c1"># Maybe try to delete existing line</span>
            <span class="n">successful_overwrite</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">old_line</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="c1"># Overwrite the old line</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">overwrite_fmt</span><span class="p">(</span>
                            <span class="s2">&quot;Deleting existing line &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">successful_overwrite</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">old_line</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">successful_overwrite</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Line could not be deleted</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">echofilter</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">warning_fmt</span><span class="p">(</span>
                            <span class="s2">&quot;Existing line &#39;</span><span class="si">{}</span><span class="s2">&#39; could not be deleted&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">target_name</span><span class="p">,</span> <span class="n">key</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">old_line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">successful_overwrite</span><span class="p">:</span>
                <span class="c1"># Change the output name so there is no collision</span>
                <span class="n">target_name</span> <span class="o">+=</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtstr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Target line name &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists. Will save&quot;</span>
                        <span class="s2">&quot; new </span><span class="si">{}</span><span class="s2"> line with name &#39;</span><span class="si">{}</span><span class="s2">&#39; instead.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">target_names</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">target_name</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">target_name</span><span class="p">:</span>
                <span class="c1"># Rename the line</span>
                <span class="n">line</span><span class="o">.</span><span class="n">Name</span> <span class="o">=</span> <span class="n">target_name</span>

            <span class="c1"># Change the color and thickness of the line</span>
            <span class="n">change_line_color_thickness</span><span class="p">(</span>
                <span class="n">line</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">line_thicknesses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Add notes to the line</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; line&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_notes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">notes</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">common_notes</span>
            <span class="n">ev_app</span><span class="o">.</span><span class="n">Exec</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> | Notes =| </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="c1"># Overwrite the EV file now the outputs have been imported</span>
        <span class="n">ev_file</span><span class="o">.</span><span class="n">Save</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_color_palette"><a class="viewcode-back" href="../../source/packages/echofilter.html#echofilter.inference.get_color_palette">[docs]</a><span class="k">def</span> <span class="nf">get_color_palette</span><span class="p">(</span><span class="n">include_xkcd</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provide a mapping of named colors from matplotlib.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    include_xkcd : bool, optional</span>
<span class="sd">        Whether to include the XKCD color palette in the output.</span>
<span class="sd">        Note that XKCD colors have `&quot;xkcd:&quot;` prepended to their names to</span>
<span class="sd">        prevent collisions with official named colors from CSS4.</span>
<span class="sd">        Default is `True`.</span>
<span class="sd">        See https://xkcd.com/color/rgb/ and</span>
<span class="sd">        https://blog.xkcd.com/2010/05/03/color-survey-results/</span>
<span class="sd">        for the XKCD colors.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    colors : dict</span>
<span class="sd">        Mapping from names of colors as strings to color value, either as</span>
<span class="sd">        an RGB tuple (fractional, 0 to 1 range) or a hexadecimal string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mcolors</span><span class="o">.</span><span class="n">BASE_COLORS</span><span class="p">,</span> <span class="o">**</span><span class="n">mcolors</span><span class="o">.</span><span class="n">CSS4_COLORS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_xkcd</span><span class="p">:</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">mcolors</span><span class="o">.</span><span class="n">XKCD_COLORS</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">colors</span></div>


<div class="viewcode-block" id="hexcolor2rgb8"><a class="viewcode-back" href="../../source/packages/echofilter.html#echofilter.inference.hexcolor2rgb8">[docs]</a><span class="k">def</span> <span class="nf">hexcolor2rgb8</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility for mapping hexadecimal colors to uint8 RGB.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    color : str</span>
<span class="sd">        A hexadecimal color string, with leading &quot;#&quot;.</span>
<span class="sd">        If the input is not a string beginning with &quot;#&quot;, it is returned as-is</span>
<span class="sd">        without raising an error.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        RGB color tuple, in uint8 format (0--255).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">color</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">color</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">color</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Scott C. Lowe<br/>
  
      &copy; Copyright 2022, Scott C. Lowe.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>